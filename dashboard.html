<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard CDA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <style>
    body {background:#f5f6fa;}
    .sidebar {
      width:240px; position:fixed; top:0; left:0; bottom:0;
      background:#343a40; color:#fff; padding-top:1rem;
    }
    .sidebar a{display:block;color:#adb5bd;padding:.75rem 1rem;text-decoration:none;}
    .sidebar a:hover,.sidebar a.active{background:#495057;color:#fff;}
    .content{margin-left:240px;padding:2rem;}
    .table thead{background:#343a40;color:#fff;}
    .badge-vencido{background:#dc3545;}
    .badge-proximo{background:#ffc107;color:#000;}
  </style>
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar">
  <h4 class="text-center text-white mb-4">CDA Dashboard</h4>
  <a href="#" class="active" data-section="clientes">Clientes</a>
  <a href="#" data-section="agenda">Agenda</a>
</nav>

<!-- Main content -->
<main class="content">
  <!-- CLIENTES -->
  <section id="clientes">
    <h2>Gestión de Clientes</h2>
    <button class="btn btn-primary mb-3" onclick="openClienteModal()">➕ Nuevo Cliente</button>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th>ID</th><th>Nombre</th><th>Tipo</th><th>Documento</th><th>Teléfono</th>
            <th>Email</th><th>Vehículos</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="clientesTable"></tbody>
      </table>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="agenda" class="d-none">
    <h2>Calendario de Citas</h2>
    <div id="calendar"></div>
  </section>
</main>

<!-- MODAL CLIENTE -->
<div class="modal fade" id="clienteModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" onsubmit="saveCliente(event)">
      <div class="modal-header">
        <h5 class="modal-title" id="clienteModalTitle">Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="clienteId">
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input type="text" id="clienteNombre" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Tipo</label>
          <select id="clienteTipo" class="form-select" required>
            <option value="persona">Persona</option>
            <option value="empresa">Empresa</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Documento</label>
          <input type="text" id="clienteDoc" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Teléfono</label>
          <input type="text" id="clienteTel" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Email</label>
          <input type="email" id="clienteEmail" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL VEHÍCULOS -->
<div class="modal fade" id="vehiculosModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vehículos de <span id="vehCliente"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <button class="btn btn-success mb-2" onclick="openVehiculoForm()">➕ Agregar Vehículo</button>
        <div id="vehiculosLista"></div>
        <div id="vehiculoForm" class="d-none mt-3">
          <h6>Nuevo Vehículo</h6>
          <div class="mb-2">
            <input type="text" id="vehPlaca" class="form-control" placeholder="Placa">
          </div>
          <div class="mb-2">
            <input type="text" id="vehMarca" class="form-control" placeholder="Marca">
          </div>
          <div class="mb-2">
            <input type="text" id="vehModelo" class="form-control" placeholder="Modelo">
          </div>
          <div class="mb-2">
            <input type="number" id="vehAnio" class="form-control" placeholder="Año">
          </div>
          <button class="btn btn-primary" onclick="saveVehiculo()">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.js"></script>
<script>
let clientes = [
  {id:1,nombre:'Juan Pérez',tipo:'persona',doc:'123456789',tel:'3001112233',email:'juan@mail.com',
   vehiculos:[
     {placa:'ABC123',marca:'Mazda',modelo:'3',anio:2019,ultima:'2024-08-01',vencimiento:'2025-08-01',citas:[{title:'Revisión',date:'2025-07-20'}]}
   ]}
];

const clienteModal = new bootstrap.Modal('#clienteModal');
const vehiculosModal = new bootstrap.Modal('#vehiculosModal');
let currentCliente = null;
let calendar;

function renderClientes(){
  const tbody=document.getElementById('clientesTable');
  tbody.innerHTML=clientes.map(c=>{
    const vehCount=c.vehiculos.length;
    return `<tr>
      <td>${c.id}</td><td>${c.nombre}</td><td>${c.tipo}</td><td>${c.doc}</td>
      <td>${c.tel}</td><td>${c.email}</td>
      <td><button class="btn btn-sm btn-info" onclick="showVehiculos(${c.id})">${vehCount} ver</button></td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editCliente(${c.id})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="deleteCliente(${c.id})">Eliminar</button>
      </td>
    </tr>`;
  }).join('');
}

function openClienteModal(){
  document.getElementById('clienteModalTitle').innerText='Nuevo Cliente';
  document.getElementById('clienteId').value='';
  ['Nombre','Tipo','Doc','Tel','Email'].forEach(f=>document.getElementById('cliente'+f).value='');
  clienteModal.show();
}

function saveCliente(e){
  e.preventDefault();
  const id = document.getElementById('clienteId').value;
  const c = {
    id: id? parseInt(id): Date.now(),
    nombre: document.getElementById('clienteNombre').value,
    tipo: document.getElementById('clienteTipo').value,
    doc: document.getElementById('clienteDoc').value,
    tel: document.getElementById('clienteTel').value,
    email: document.getElementById('clienteEmail').value,
    vehiculos: id? clientes.find(x=>x.id==id).vehiculos : []
  };
  if(id){ clientes = clientes.map(x=> x.id==id? c : x); }
  else{ clientes.push(c); }
  renderClientes();
  clienteModal.hide();
}

function editCliente(id){
  const c=clientes.find(x=>x.id==id);
  document.getElementById('clienteModalTitle').innerText='Editar Cliente';
  document.getElementById('clienteId').value=c.id;
  document.getElementById('clienteNombre').value=c.nombre;
  document.getElementById('clienteTipo').value=c.tipo;
  document.getElementById('clienteDoc').value=c.doc;
  document.getElementById('clienteTel').value=c.tel;
  document.getElementById('clienteEmail').value=c.email;
  clienteModal.show();
}

function deleteCliente(id){
  if(confirm('¿Eliminar cliente?')){
    clientes=clientes.filter(c=>c.id!=id);
    renderClientes();
  }
}

function showVehiculos(id){
  currentCliente=clientes.find(c=>c.id==id);
  document.getElementById('vehCliente').innerText=currentCliente.nombre;
  renderVehiculos();
  vehiculosModal.show();
}

function renderVehiculos(){
  const cont=document.getElementById('vehiculosLista');
  cont.innerHTML=currentCliente.vehiculos.map(v=>{
    const hoy=new Date();
    const venc=new Date(v.vencimiento);
    let badge='';
    const diff=(venc-hoy)/(1000*60*60*24);
    if(diff<0) badge='<span class="badge badge-vencido ms-1">Vencido</span>';
    else if(diff<30) badge='<span class="badge badge-proximo ms-1">Próximo</span>';
    return `<div class="border p-2 mb-2">
      <strong>${v.placa}</strong> - ${v.marca} ${v.modelo} (${v.anio}) ${badge}<br>
      Última: ${v.ultima} | Vence: ${v.vencimiento}<br>
      <button class="btn btn-sm btn-outline-primary mt-1" onclick="recordatorio('${v.placa}')">Enviar recordatorio</button>
    </div>`;
  }).join('') || '<p>No hay vehículos.</p>';
}

function openVehiculoForm(){
  document.getElementById('vehiculoForm').classList.toggle('d-none');
}

function saveVehiculo(){
  const v={
    placa:document.getElementById('vehPlaca').value,
    marca:document.getElementById('vehMarca').value,
    modelo:document.getElementById('vehModelo').value,
    anio:document.getElementById('vehAnio').value,
    ultima:new Date().toISOString().slice(0,10),
    vencimiento:new Date(new Date().setFullYear(new Date().getFullYear()+1)).toISOString().slice(0,10),
    citas:[]
  };
  currentCliente.vehiculos.push(v);
  renderVehiculos();
  document.getElementById('vehiculoForm').classList.add('d-none');
}

function recordatorio(placa){
  alert('Recordatorio enviado a '+currentCliente.email+' para vehículo '+placa);
}

function initCalendar(){
  const el=document.getElementById('calendar');
  calendar=new FullCalendar.Calendar(el,{
    initialView:'dayGridMonth',
    locale:'es',
    events: clientes.flatMap(c=>c.vehiculos.flatMap(v=>v.citas))
  });
  calendar.render();
}

document.querySelectorAll('.sidebar a').forEach(link=>{
  link.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.sidebar a').forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    const sec=link.dataset.section;
    document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
    document.getElementById(sec).classList.remove('d-none');
    if(sec==='agenda' && calendar){ calendar.render(); }
  });
});

renderClientes();
document.addEventListener('DOMContentLoaded',initCalendar);
</script>
</body>
</html>
