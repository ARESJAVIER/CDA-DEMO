<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CDA Demo — Panel interactivo</title>

  <!-- Bootstrap + FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{--accent:#00b7d9;--dark:#002D72}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:#f4f6f9}
    .navbar{background:linear-gradient(90deg,var(--dark),#003b8a)}
    .brand{color:white;font-weight:700}
    .container-main{padding:28px}
    .card-action{cursor:pointer;transition:all .18s ease}
    .card-action:hover{transform:translateY(-6px);box-shadow:0 10px 24px rgba(0,0,0,0.08)}
    .sidebar{min-width:260px;background:var(--dark);color:#fff;height:100vh;padding:20px;position:fixed}
    .sidebar .profile-img{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid var(--accent)}
    .menu a{color:#e6eef6;text-decoration:none;display:flex;align-items:center;padding:10px;border-radius:8px}
    .menu a:hover, .menu a.active{background:var(--accent);color:#002D72;font-weight:600}
    .content{margin-left:280px;padding:26px}
    .btn-primary{background:var(--accent);border:none}
    .badge-urgent{background:#ff6b6b;color:white}
    .small-muted{color:#6b7280;font-size:.95rem}
    .vehicle-row:hover{background:#f8fafc}
    /* responsive */
    @media(max-width:990px){
      .sidebar{display:none}
      .content{margin-left:0;padding:12px}
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid px-4">
    <span class="brand">CDA — Demo</span>
    <div class="ms-auto d-flex align-items-center">
      <button id="btn-login-open" class="btn btn-outline-light me-2"><i class="fa fa-right-to-bracket"></i> Ingresar</button>
      <button id="btn-register-open" class="btn btn-light"><i class="fa fa-user-plus"></i> Registrarse</button>
    </div>
  </div>
</nav>

<!-- LAYOUT -->
<div class="d-flex">
  <!-- SIDEBAR -->
  <aside class="sidebar d-none d-lg-block">
    <div class="text-center mb-3">
      <img id="profilePicSidebar" src="https://i.pravatar.cc/84" class="profile-img mb-2" alt="foto">
      <div id="sidebarName" style="font-weight:600">Visitante</div>
      <div id="sidebarId" class="small-muted">No conectado</div>
    </div>

    <nav class="menu">
      <a href="#" class="d-flex align-items-center mb-2 active" data-view="dashboard"><i class="fa fa-house fa-fw me-2"></i> <span>Inicio</span></a>
      <a href="#" class="d-flex align-items-center mb-2" data-view="vehiculos"><i class="fa fa-car-side fa-fw me-2"></i> <span>Mis Vehículos</span></a>
      <a href="#" class="d-flex align-items-center mb-2" data-view="citas"><i class="fa fa-calendar-check fa-fw me-2"></i> <span>Agenda</span></a>
      <a href="#" class="d-flex align-items-center mb-2" data-view="notificaciones"><i class="fa fa-bell fa-fw me-2"></i> <span>Notificaciones</span></a>
      <a href="#" class="d-flex align-items-center mb-2" data-view="chat"><i class="fa fa-comments fa-fw me-2"></i> <span>Chatbot</span></a>
      <a href="#" class="d-flex align-items-center mb-2" data-view="perfil"><i class="fa fa-user fa-fw me-2"></i> <span>Perfil</span></a>
      <a href="#" class="d-flex align-items-center text-danger mt-3" id="logoutBtn"><i class="fa fa-sign-out-alt fa-fw me-2"></i> <span>Cerrar sesión</span></a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content container-main" id="mainContent">

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Panel</h3>
        <div id="userControls" style="min-width:220px"></div>
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <div class="card p-3 card-action" onclick="navigate('vehiculos')">
            <div class="d-flex align-items-center">
              <div class="me-3"><i class="fa fa-car fa-2x" style="color:var(--dark)"></i></div>
              <div>
                <div style="font-weight:700">Mis Vehículos</div>
                <div class="small-muted" id="countVehicles">0 registrados</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 card-action" onclick="navigate('citas')">
            <div class="d-flex align-items-center">
              <div class="me-3"><i class="fa fa-calendar-check fa-2x" style="color:var(--dark)"></i></div>
              <div>
                <div style="font-weight:700">Citas</div>
                <div class="small-muted" id="countAppointments">0 programadas</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 card-action" onclick="navigate('notificaciones')">
            <div class="d-flex align-items-center">
              <div class="me-3"><i class="fa fa-bell fa-2x" style="color:var(--dark)"></i></div>
              <div>
                <div style="font-weight:700">Notificaciones</div>
                <div class="small-muted" id="countNotifications">0 alertas</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <div class="row">
        <div class="col-lg-8">
          <h5>Resumen rápido</h5>
          <div id="quickList" class="list-group mt-2"></div>
        </div>

        <div class="col-lg-4">
          <h5>Acciones rápidas</h5>
          <div class="d-grid gap-2 mt-2">
            <button class="btn btn-primary" onclick="openAddVehicleModal()"><i class="fa fa-plus me-2"></i>Agregar vehículo</button>
            <button class="btn btn-outline-secondary" onclick="openAppointmentModal()"><i class="fa fa-calendar-plus me-2"></i>Agendar cita</button>
            <button class="btn btn-outline-secondary" onclick="notifyCheckExpirations()"><i class="fa fa-bell me-2"></i>Revisar vencimientos</button>
          </div>
        </div>
      </div>
    </div>

    <!-- VEHÍCULOS VIEW -->
    <div id="view-vehiculos" class="view d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Mis Vehículos</h3>
        <div>
          <button class="btn btn-primary" onclick="openAddVehicleModal()"><i class="fa fa-plus me-1"></i> Nuevo vehículo</button>
        </div>
      </div>

      <div class="card p-3">
        <div id="vehiclesTableContainer"></div>
      </div>
    </div>

    <!-- CITAS VIEW -->
    <div id="view-citas" class="view d-none">
      <div class="d-flex justify-content-between">
        <h3>Agenda de citas</h3>
        <div>
          <button class="btn btn-primary" onclick="openAppointmentModal()"><i class="fa fa-calendar-plus me-1"></i> Agendar nueva</button>
        </div>
      </div>
      <div class="card p-3 mt-3">
        <div id="appointmentsList"></div>
      </div>
    </div>

    <!-- NOTIFICACIONES VIEW -->
    <div id="view-notificaciones" class="view d-none">
      <h3>Notificaciones</h3>
      <div class="card p-3 mt-3">
        <div id="notificationsList"></div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="view-chat" class="view d-none">
      <h3>Asistente virtual</h3>
      <div class="card p-3 mt-3">
        <div id="chatWindow" style="height:320px; overflow:auto; padding:8px; border-radius:8px; background:#fcfdff"></div>
        <div class="d-flex mt-3">
          <input id="chatInput" class="form-control me-2" placeholder="Escribe: 'agendar cita', '¿cuándo vence ABC123?'">
          <button class="btn btn-primary" onclick="sendChat()">Enviar</button>
        </div>
      </div>
    </div>

    <!-- PERFIL VIEW -->
    <div id="view-perfil" class="view d-none">
      <h3>Perfil</h3>
      <div class="card p-3 mt-3">
        <div class="row g-3">
          <div class="col-md-4 text-center">
            <img id="profilePreview" src="https://i.pravatar.cc/120" class="img-fluid rounded-circle mb-2" alt="foto">
            <input class="form-control" type="file" id="uploadPhoto" accept="image/*">
          </div>
          <div class="col-md-8">
            <label class="form-label">Nombre</label>
            <input id="perfilNombre" class="form-control mb-2">
            <label class="form-label">Documento (Cédula o NIT)</label>
            <input id="perfilId" class="form-control mb-2" disabled>
            <label class="form-label">Correo</label>
            <input id="perfilCorreo" class="form-control mb-2">
            <label class="form-label">Teléfono</label>
            <input id="perfilTelefono" class="form-control mb-2">
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary" onclick="saveProfile()">Guardar</button>
              <button class="btn btn-outline-secondary" onclick="logout()">Cerrar sesión</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- MODALS: Registro/Login/Vehículo/Cita -->
<!-- Register Modal -->
<div class="modal" id="modalRegister" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formRegister" class="modal-body">
        <h5>Crear cuenta</h5>
        <div class="mb-2">
          <label class="form-label">Tipo</label>
          <select id="regType" class="form-select">
            <option value="natural">Persona natural</option>
            <option value="empresa">Empresa</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input id="regName" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label" id="regDocLabel">Cédula</label>
          <input id="regDoc" class="form-control" required>
        </div>
        <div class="mb-2" id="regVehicleDiv">
          <label class="form-label">Placa inicial (se usará como contraseña)</label>
          <input id="regPlaca" class="form-control" placeholder="ABC123">
        </div>
        <div class="mb-2" id="regPassDiv" style="display:none">
          <label class="form-label">Contraseña (solo empresas)</label>
          <input id="regPass" type="password" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Correo</label>
          <input id="regEmail" type="email" class="form-control">
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal" id="modalLogin" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formLogin" class="modal-body">
        <h5>Iniciar sesión</h5>
        <div class="mb-2">
          <label class="form-label">Documento (cédula o NIT)</label>
          <input id="loginDoc" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Contraseña</label>
          <input id="loginPass" type="password" class="form-control" required>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Entrar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Vehicle Modal -->
<div class="modal" id="modalVehicle" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formVehicle" class="modal-body">
        <h5 id="vehicleModalTitle">Agregar vehículo</h5>
        <div class="mb-2"><label class="form-label">Placa</label><input id="vehPlaca" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Marca</label><input id="vehMarca" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Modelo</label><input id="vehModelo" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Año</label><input id="vehAno" class="form-control" type="number"></div>
        <div class="mb-2"><label class="form-label">Fecha última revisión</label><input id="vehUltRev" class="form-control" type="date"></div>
        <div class="mb-2"><label class="form-label">Fecha de vencimiento</label><input id="vehVenc" class="form-control" type="date" required></div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Appointment Modal -->
<div class="modal" id="modalAppointment" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formAppointment" class="modal-body">
        <h5>Agendar cita</h5>
        <div class="mb-2">
          <label class="form-label">Vehículo</label>
          <select id="appVehicle" class="form-select" required></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Servicio</label>
          <select id="appService" class="form-select" required>
            <option>Revisión técnico-mecánica</option>
            <option>Revisión de gases</option>
            <option>Inspección frenos</option>
            <option>Chequeo completo</option>
          </select>
        </div>
        <div class="mb-2"><label class="form-label">Fecha</label><input id="appDate" class="form-control" type="date" required></div>
        <div class="mb-2"><label class="form-label">Hora</label><input id="appTime" class="form-control" type="time" required></div>
        <div class="mb-2"><label class="form-label">Notas</label><input id="appNotes" class="form-control"></div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Reservar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/*
  CDA Demo (static)
  - Usa localStorage para guardar: usuarios, sesión, vehículos, citas, notificaciones.
  - Login por defecto:
      Persona natural: cedula + contraseña = placa inicial (se puede cambiar luego).
      Empresa: NIT + contraseña (se define al registrar).
  - Chatbot simple con intentos básicos.
  - Para producción: conectar a backend, WhatsApp Business API, DB.
*/

/* ---------- Helpers / Storage ---------- */
const LS_USERS = 'cda_users_v1';
const LS_SESSION = 'cda_session_v1';

function loadUsers(){ return JSON.parse(localStorage.getItem(LS_USERS) || '[]'); }
function saveUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
function getSession(){ return JSON.parse(localStorage.getItem(LS_SESSION) || 'null'); }
function setSession(userId){ localStorage.setItem(LS_SESSION, JSON.stringify(userId)); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }

/* ---------- Initial sample data (only if empty) ---------- */
if(!localStorage.getItem(LS_USERS)){
  const demoUsers = [{
    id:'12345678', type:'natural', name:'Cliente Demo', email:'demo@ej.com', phone:'3000000000',
    password:'ABC123', // placa inicial used as password
    photo:null,
    vehicles:[
      {plate:'ABC123', brand:'Toyota', model:'Corolla', year:2018, lastRevision:'2024-09-01', expiry:'2025-09-01'}
    ],
    appointments:[],
    notifications:[],
    settings:{reminderDays:30}
  }];
  saveUsers(demoUsers);
}

/* ---------- UI modals bootstrap ---------- */
const modalRegister = new bootstrap.Modal(document.getElementById('modalRegister'));
const modalLogin = new bootstrap.Modal(document.getElementById('modalLogin'));
const modalVehicle = new bootstrap.Modal(document.getElementById('modalVehicle'));
const modalAppointment = new bootstrap.Modal(document.getElementById('modalAppointment'));

/* ---------- Global state ---------- */
let currentUser = null; // user id string

/* ---------- DOM refs ---------- */
const btnLoginOpen = document.getElementById('btn-login-open');
const btnRegisterOpen = document.getElementById('btn-register-open');
const logoutBtn = document.getElementById('logoutBtn');

btnLoginOpen.addEventListener('click', ()=>modalLogin.show());
btnRegisterOpen.addEventListener('click', ()=>{ document.getElementById('regType').value='natural'; toggleRegFields(); modalRegister.show(); });
logoutBtn.addEventListener('click', ()=>logout());

/* ---------- Register behavior ---------- */
document.getElementById('regType').addEventListener('change', toggleRegFields);
function toggleRegFields(){
  const type = document.getElementById('regType').value;
  if(type === 'natural'){
    document.getElementById('regDocLabel').innerText = 'Cédula';
    document.getElementById('regVehicleDiv').style.display = '';
    document.getElementById('regPassDiv').style.display = 'none';
  } else {
    document.getElementById('regDocLabel').innerText = 'NIT';
    document.getElementById('regVehicleDiv').style.display = 'none';
    document.getElementById('regPassDiv').style.display = '';
  }
}

document.getElementById('formRegister').addEventListener('submit', function(e){
  e.preventDefault();
  const type = document.getElementById('regType').value;
  const name = document.getElementById('regName').value.trim();
  const doc = document.getElementById('regDoc').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const placa = document.getElementById('regPlaca').value.trim().toUpperCase();
  const pass = document.getElementById('regPass').value;

  if(!name || !doc){ alert('Por favor completa los datos.'); return; }
  const users = loadUsers();
  if(users.find(u=>u.id === doc)){ alert('Ya existe una cuenta con ese documento.'); return; }

  const newUser = {
    id: doc, type, name, email, phone:'', password: (type==='natural'? (placa || '') : (pass || '')),
    photo:null, vehicles: [], appointments:[], notifications:[], settings:{reminderDays:30}
  };
  if(type==='natural' && placa) newUser.vehicles.push({plate:placa, brand:'', model:'', year:'', lastRevision:'', expiry:''});
  users.push(newUser);
  saveUsers(users);
  alert('Cuenta creada. Ingresa con tu documento y contraseña (para persona natural la contraseña es la placa inicial).');
  modalRegister.hide();
});

/* ---------- Login ---------- */
document.getElementById('formLogin').addEventListener('submit', function(e){
  e.preventDefault();
  const doc = document.getElementById('loginDoc').value.trim();
  const pass = document.getElementById('loginPass').value;
  const users = loadUsers();
  const u = users.find(x=>x.id===doc);
  if(!u){ alert('Usuario no encontrado'); return; }
  if(u.password !== pass){ alert('Contraseña incorrecta'); return; }
  // success
  setSession(u.id);
  currentUser = u.id;
  modalLogin.hide();
  refreshUI();
  showView('dashboard');
});

/* ---------- Logout ---------- */
function logout(){
  clearSession();
  currentUser = null;
  refreshUI();
  showView('dashboard');
}

/* ---------- On load, restore session ---------- */
(function init(){
  const sess = getSession();
  if(sess){ currentUser = sess; }
  refreshUI();
  attachHandlers();
  scanExpirations(); // generate notifications on load
})();

/* ---------- Attach sidebar/menu handlers ---------- */
function attachHandlers(){
  document.querySelectorAll('.menu a').forEach(a=>{
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      document.querySelectorAll('.menu a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const view = a.getAttribute('data-view');
      showView(view);
    });
  });
}

/* ---------- Navigation show/hide views ---------- */
function showView(view){
  document.querySelectorAll('.view').forEach(v=>v.classList.add('d-none'));
  const el = document.getElementById('view-'+view);
  if(el) el.classList.remove('d-none');
  // update controls
  updateUserControls();
  if(view==='vehiculos') renderVehicles();
  if(view==='citas') renderAppointments();
  if(view==='notificaciones') renderNotifications();
  if(view==='perfil') renderProfile();
  if(view==='chat') scrollChatToBottom();
}
function navigate(view){ showView(view); }

/* ---------- UI refresher ---------- */
function refreshUI(){
  // sidebar text
  const sidebarName = document.getElementById('sidebarName');
  const sidebarId = document.getElementById('sidebarId');
  const profilePicSidebar = document.getElementById('profilePicSidebar');

  if(currentUser){
    const users = loadUsers();
    const u = users.find(x=>x.id===currentUser);
    sidebarName.innerText = u.name;
    sidebarId.innerText = u.id;
    profilePicSidebar.src = u.photo || `https://i.pravatar.cc/84?u=${u.id}`;
  } else {
    sidebarName.innerText = 'Visitante';
    sidebarId.innerText = 'No conectado';
    profilePicSidebar.src = 'https://i.pravatar.cc/84';
  }

  // counters
  const users = loadUsers();
  const u = users.find(x=>x.id===currentUser);
  const countVehicles = u ? (u.vehicles||[]).length : 0;
  const countAppts = u ? (u.appointments||[]).length : 0;
  const countNotifs = u ? (u.notifications||[]).length : 0;
  document.getElementById('countVehicles').innerText = `${countVehicles} registrados`;
  document.getElementById('countAppointments').innerText = `${countAppts} programadas`;
  document.getElementById('countNotifications').innerText = `${countNotifs} alertas`;

  // quick list
  const quick = document.getElementById('quickList');
  quick.innerHTML = '';
  if(!u){
    quick.innerHTML = '<div class="small-muted">Conéctate para ver tu resumen.</div>';
  } else {
    // upcoming expirations
    const soon = (u.vehicles||[]).filter(v=>v.expiry).map(v=>({plate:v.plate, expiry:v.expiry})).sort((a,b)=>new Date(a.expiry)-new Date(b.expiry));
    if(soon.length===0) quick.innerHTML = '<div class="small-muted">No hay vehículos registrados.</div>';
    else {
      soon.slice(0,4).forEach(it=>{
        const diffDays = Math.ceil((new Date(it.expiry) - new Date())/86400000);
        const badge = diffDays <= 30 ? '<span class="badge badge-urgent ms-2">Próximo</span>' : '';
        const li = document.createElement('div'); li.className='list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<div><strong>${it.plate}</strong> <div class="small-muted">Vence: ${it.expiry}</div></div><div>${badge}</div>`;
        quick.appendChild(li);
      });
    }
  }

  // user controls (login/register or profile buttons)
  updateUserControls();
}

/* ---------- updateUserControls ---------- */
function updateUserControls(){
  const container = document.getElementById('userControls');
  container.innerHTML = '';
  const session = currentUser;
  if(!session){
    container.innerHTML = `<button class="btn btn-light me-2" onclick="modalLogin.show()">Iniciar</button>
                           <button class="btn btn-outline-light" onclick="modalRegister.show()">Crear cuenta</button>`;
  } else {
    container.innerHTML = `<button class="btn btn-outline-secondary me-2" onclick="showView('perfil')"><i class="fa fa-user me-1"></i> Mi perfil</button>
                           <button class="btn btn-outline-secondary" onclick="logout()"><i class="fa fa-sign-out-alt me-1"></i> Salir</button>`;
  }
}

/* ---------- Vehicles: render / add / edit / delete ---------- */
function renderVehicles(){
  const container = document.getElementById('vehiclesTableContainer');
  const users = loadUsers();
  const u = users.find(x=>x.id===currentUser);
  if(!u){
    container.innerHTML = '<div class="small-muted">Debes iniciar sesión para gestionar vehículos.</div>';
    return;
  }
  const rows = (u.vehicles||[]);
  let html = `<div class="d-flex justify-content-between mb-3">
                <div><strong>Total: ${rows.length}</strong></div>
                <div><button class="btn btn-sm btn-outline-primary" onclick="openAddVehicleModal()">Agregar vehículo</button></div>
              </div>`;
  if(rows.length===0) html += '<div class="small-muted">No hay vehículos registrados.</div>';
  else {
    html += `<div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead><tr><th>Placa</th><th>Marca</th><th>Modelo</th><th>Vencimiento</th><th>Acciones</th></tr></thead><tbody>`;
    rows.forEach((v,i)=>{
      html += `<tr class="vehicle-row"><td><strong>${v.plate}</strong></td><td>${v.brand||'-'}</td><td>${v.model||'-'}</td>
        <td>${v.expiry||'-'}</td>
        <td>
          <button class="btn btn-sm btn-outline-success me-1" onclick="openEditVehicle(${i})"><i class="fa fa-pen"></i></button>
          <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteVehicle(${i})"><i class="fa fa-trash"></i></button>
          <button class="btn btn-sm btn-outline-primary" onclick="prepareWhatsApp('${v.plate}')"><i class="fa fa-whatsapp"></i></button>
        </td></tr>`;
    });
    html += `</tbody></table></div>`;
  }
  container.innerHTML = html;
}

/* ---------- Vehicle modal logic ---------- */
let editingVehicleIndex = null;
function openAddVehicleModal(){
  editingVehicleIndex = null;
  document.getElementById('vehicleModalTitle').innerText = 'Agregar vehículo';
  document.getElementById('vehPlaca').value = '';
  document.getElementById('vehMarca').value = '';
  document.getElementById('vehModelo').value = '';
  document.getElementById('vehAno').value = '';
  document.getElementById('vehUltRev').value = '';
  document.getElementById('vehVenc').value = '';
  modalVehicle.show();
}
function openEditVehicle(idx){
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  const v = u.vehicles[idx];
  editingVehicleIndex = idx;
  document.getElementById('vehicleModalTitle').innerText = 'Editar vehículo';
  document.getElementById('vehPlaca').value = v.plate;
  document.getElementById('vehMarca').value = v.brand;
  document.getElementById('vehModelo').value = v.model;
  document.getElementById('vehAno').value = v.year;
  document.getElementById('vehUltRev').value = v.lastRevision;
  document.getElementById('vehVenc').value = v.expiry;
  modalVehicle.show();
}
document.getElementById('formVehicle').addEventListener('submit', function(e){
  e.preventDefault();
  const plate = document.getElementById('vehPlaca').value.trim().toUpperCase();
  const brand = document.getElementById('vehMarca').value.trim();
  const model = document.getElementById('vehModelo').value.trim();
  const year = document.getElementById('vehAno').value;
  const lastRevision = document.getElementById('vehUltRev').value;
  const expiry = document.getElementById('vehVenc').value;
  if(!plate || !expiry){ alert('Placa y fecha de vencimiento son obligatorias'); return; }
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u) { alert('Debes iniciar sesión'); return; }
  const item = {plate, brand, model, year, lastRevision, expiry};
  if(editingVehicleIndex === null){
    // ensure no duplicate plate
    if(u.vehicles.find(v=>v.plate===plate)){ alert('Placa ya registrada'); return;}
    u.vehicles.push(item);
  } else {
    // editing
    u.vehicles[editingVehicleIndex] = item;
  }
  saveUsers(users);
  modalVehicle.hide();
  renderVehicles();
  refreshUI();
});

/* ---------- delete vehicle ---------- */
function deleteVehicle(idx){
  if(!confirm('Eliminar vehículo?')) return;
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  u.vehicles.splice(idx,1);
  saveUsers(users);
  renderVehicles(); refreshUI();
}

/* ---------- Appointments ---------- */
function openAppointmentModal(){
  // populate vehicles
  const sel = document.getElementById('appVehicle');
  sel.innerHTML = '';
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u || !u.vehicles.length){ alert('Agrega un vehículo primero'); return; }
  u.vehicles.forEach(v=>{
    const opt = document.createElement('option'); opt.value = v.plate; opt.text = `${v.plate} — ${v.model||v.brand||''}`; sel.appendChild(opt);
  });
  document.getElementById('appDate').value = '';
  document.getElementById('appTime').value = '';
  document.getElementById('appNotes').value = '';
  modalAppointment.show();
}
document.getElementById('formAppointment').addEventListener('submit', function(e){
  e.preventDefault();
  const plate = document.getElementById('appVehicle').value;
  const service = document.getElementById('appService').value;
  const date = document.getElementById('appDate').value;
  const time = document.getElementById('appTime').value;
  const notes = document.getElementById('appNotes').value;
  if(!date || !time){ alert('Fecha y hora requeridas'); return; }
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  const appt = {id: 'A'+Date.now(), plate, service, date, time, notes, createdAt: new Date().toISOString()};
  u.appointments.push(appt);
  saveUsers(users);
  modalAppointment.hide();
  renderAppointments(); refreshUI();
  alert('Cita registrada (demo local).');
});

/* ---------- render appointments ---------- */
function renderAppointments(){
  const container = document.getElementById('appointmentsList');
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u){ container.innerHTML = '<div class="small-muted">Inicia sesión para ver citas</div>'; return; }
  if(u.appointments.length===0) { container.innerHTML = '<div class="small-muted">No hay citas programadas.</div>'; return; }
  let html = '<div class="list-group">';
  u.appointments.sort((a,b)=> new Date(a.date+' '+a.time) - new Date(b.date+' '+b.time));
  u.appointments.forEach(ap=>{
    html += `<div class="list-group-item d-flex justify-content-between align-items-start">
      <div>
        <div><strong>${ap.service}</strong> — <span class="small-muted">${ap.plate}</span></div>
        <div class="small-muted">${ap.date} ${ap.time} · ${ap.notes||''}</div>
      </div>
      <div>
        <button class="btn btn-sm btn-outline-danger" onclick="cancelAppointment('${ap.id}')"><i class="fa fa-trash"></i></button>
      </div>
    </div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

/* ---------- cancel appointment ---------- */
function cancelAppointment(id){
  if(!confirm('Cancelar cita?')) return;
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  u.appointments = u.appointments.filter(a=>a.id!==id);
  saveUsers(users); renderAppointments(); refreshUI();
}

/* ---------- Notifications ---------- */
/* Scans vehicles and creates notifications when expiry within user.settings.reminderDays */
function scanExpirations(){
  const users = loadUsers();
  users.forEach(u=>{
    const days = u.settings?.reminderDays || 30;
    (u.vehicles||[]).forEach(v=>{
      if(!v.expiry) return;
      const diff = Math.ceil((new Date(v.expiry) - new Date()) / 86400000);
      // create notification if within window and not yet exists
      const exists = (u.notifications||[]).some(n=>n.type==='expiry' && n.plate===v.plate && n.expiry===v.expiry);
      if(diff<=days && !exists){
        u.notifications.push({id:'N'+Date.now()+Math.random(), type:'expiry', plate:v.plate, expiry:v.expiry, daysLeft:diff, createdAt:new Date().toISOString(), read:false});
      }
    });
  });
  saveUsers(users);
}
function notifyCheckExpirations(){
  scanExpirations();
  renderNotifications();
  refreshUI();
  alert('Se actualizaron las notificaciones (demo local).');
}

/* render notifications */
function renderNotifications(){
  const container = document.getElementById('notificationsList');
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u) { container.innerHTML = '<div class="small-muted">Inicia sesión para ver notificaciones.</div>'; return; }
  if(!u.notifications || u.notifications.length===0){ container.innerHTML = '<div class="small-muted">No hay notificaciones.</div>'; return; }
  let html = '<div class="list-group">';
  u.notifications.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  u.notifications.forEach(n=>{
    if(n.type==='expiry'){
      html += `<div class="list-group-item d-flex justify-content-between align-items-start">
        <div>
          <div><strong>Vencimiento próximo — ${n.plate}</strong></div>
          <div class="small-muted">Fecha: ${n.expiry} · Quedan ${n.daysLeft} días</div>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-success me-1" onclick="sendWhatsAppForPlate('${n.plate}','${n.expiry}')"><i class="fa fa-whatsapp"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="markNotifRead('${n.id}')"><i class="fa fa-check"></i></button>
        </div>
      </div>`;
    } else {
      html += `<div class="list-group-item">${JSON.stringify(n)}</div>`;
    }
  });
  html += '</div>';
  container.innerHTML = html;
}
function markNotifRead(id){
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  u.notifications = u.notifications.map(n=> n.id===id ? {...n, read:true} : n);
  saveUsers(users); renderNotifications(); refreshUI();
}

/* send whatsapp with prefilled message for a plate */
function sendWhatsAppForPlate(plate, expiry){
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u) { alert('Inicia sesión'); return; }
  const base = `Hola, soy ${u.name}. El vehículo ${plate} tiene vencimiento el ${expiry}. ¿Pueden ayudarme con la cita?`;
  const phone = ''; // si deseas predeterminar teléfono del CDA, colócalo aquí
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(base)}`;
  window.open(url, '_blank');
}

/* prepare whatsapp button from vehicles list */
function prepareWhatsApp(plate){
  // quick message to contact CDA for that plate
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  const message = `Hola, soy ${u?.name||''}. Necesito información sobre el vehículo ${plate}.`;
  const url = `https://wa.me/?text=${encodeURIComponent(message)}`; // leaves phone empty so user can select contact
  window.open(url, '_blank');
}

/* ---------- Chatbot (simple rule-based) ---------- */
function appendChat(message, from='user'){
  const windowChat = document.getElementById('chatWindow');
  const bubble = document.createElement('div');
  bubble.className = from==='user' ? 'text-end mb-2' : 'text-start mb-2';
  bubble.innerHTML = `<div style="display:inline-block;padding:8px 12px;border-radius:12px;background:${from==='user'? '#e6f7ff':'#f1f5f9'}">${message}</div>`;
  windowChat.appendChild(bubble);
  windowChat.scrollTop = windowChat.scrollHeight;
}
function scrollChatToBottom(){ const w = document.getElementById('chatWindow'); w.scrollTop = w.scrollHeight; }

function sendChat(){
  const inp = document.getElementById('chatInput');
  const text = inp.value.trim();
  if(!text) return;
  appendChat(text,'user');
  inp.value = '';
  // simple intents
  setTimeout(()=>{
    const t = text.toLowerCase();
    if(t.includes('agendar') || t.includes('cita')){
      appendChat('Puedo ayudarte a agendar. ¿Qué vehículo quieres usar (placa)?', 'bot');
      return;
    }
    if(t.match(/[A-Z]{1,3}\d{2,4}/i) || t.match(/\b[a-z]{1,3}\d{2,4}\b/i) || t.includes('placa')){
      // try to parse plate and ask date
      const words = text.split(/\s+/);
      const possible = words.find(w=>w.match(/[A-Z]{1,3}\d{2,4}/i) || w.match(/\b[a-z]{1,3}\d{2,4}\b/i));
      if(possible){
        appendChat(`Ok, entendí la placa ${possible.toUpperCase()}. Dime fecha (YYYY-MM-DD) para la cita.`, 'bot');
        return;
      }
    }
    if(t.match(/\d{4}-\d{2}-\d{2}/)){
      appendChat('Perfecto. ¿Y la hora? (HH:MM)', 'bot'); return;
    }
    if(t.match(/\d{2}:\d{2}/)){
      appendChat('Confirmo la cita en el sistema demo. ¿Qué servicio? (ej. Revisión técnico-mecánica)', 'bot'); return;
    }
    if(t.includes('venc') || t.includes('vence')){
      // extract plate maybe
      const plateMatch = text.match(/([A-Z]{1,3}\d{2,4})/i);
      const users = loadUsers(), u = users.find(x=>x.id===currentUser);
      if(plateMatch && u){
        const p = plateMatch[0].toUpperCase();
        const veh = (u.vehicles||[]).find(v=>v.plate===p);
        if(veh) appendChat(`El vehículo ${p} vence el ${veh.expiry || 'sin fecha registrada'}`, 'bot');
        else appendChat(`No encontré ${p} en tus vehículos.`, 'bot');
      } else appendChat('Dime la placa para revisar el vencimiento, por favor.', 'bot');
      return;
    }
    // fallback
    appendChat('Lo siento, no entendí bien. Puedo: agendar cita, revisar vencimiento por placa o mostrar mis vehículos. Escribe "agendar" o "vencimiento ABC123".', 'bot');
  },600);
}

/* ---------- Profile: upload photo / save ---------- */
document.getElementById('uploadPhoto').addEventListener('change', function(){
  const f = this.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){
    document.getElementById('profilePreview').src = e.target.result;
  };
  reader.readAsDataURL(f);
});
function renderProfile(){
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u) {
    document.getElementById('profilePreview').src = 'https://i.pravatar.cc/100';
    document.getElementById('perfilNombre').value = '';
    document.getElementById('perfilId').value = '';
    document.getElementById('perfilCorreo').value = '';
    document.getElementById('perfilTelefono').value = '';
    return;
  }
  document.getElementById('profilePreview').src = u.photo || `https://i.pravatar.cc/100?u=${u.id}`;
  document.getElementById('perfilNombre').value = u.name;
  document.getElementById('perfilId').value = u.id;
  document.getElementById('perfilCorreo').value = u.email || '';
  document.getElementById('perfilTelefono').value = u.phone || '';
}
function saveProfile(){
  const users = loadUsers(); const u = users.find(x=>x.id===currentUser);
  if(!u) { alert('No hay sesión'); return; }
  u.name = document.getElementById('perfilNombre').value.trim();
  u.email = document.getElementById('perfilCorreo').value.trim();
  u.phone = document.getElementById('perfilTelefono').value.trim();
  // photo
  const src = document.getElementById('profilePreview').src;
  u.photo = src;
  saveUsers(users);
  alert('Perfil guardado (demo local).');
  refreshUI();
}

/* ---------- small helpers ---------- */
function sendWhatsAppForPlate(plate, expiry){
  // convenience wrapper if called from outside (older function)
  sendWhatsAppForPlate; // noop, defined earlier
}

/* ---------- Utility: quick scan expirations on login ---------- */
function scanExpirations(){
  // already defined above, but ensure called
  scanExpirations;
}

/* ---------- render notifications on load ---------- */
function renderNotifications(){ /* defined above */ }

/* ---------- keyboard enter on chat ---------- */
document.getElementById('chatInput').addEventListener('keydown', function(e){
  if(e.key==='Enter'){ e.preventDefault(); sendChat(); }
});

/* ---------- vehicle whatsapp caller wrapper for html onclick ---------- */
window.prepareWhatsApp = prepareWhatsApp;
window.openAddVehicleModal = openAddVehicleModal;
window.openAppointmentModal = openAppointmentModal;
window.navigate = navigate;
window.openEditVehicle = openEditVehicle;
window.deleteVehicle = deleteVehicle;

/* ---------- On page updates: refresh UI periodically ---------- */
setInterval(()=>{
  // refresh counts and quick list
  refreshUI();
}, 5000);

</script>
</body>
</html>
